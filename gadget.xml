<?xml version="1.0" encoding="UTF-8"?>
<Module>
  <ModulePrefs title="GeePivo"
    description="Creates Pivotal Tracker Stories from Emails (oxospl.nazwa.pl, 004)"
    height="200"
    author="Wojciech Kruszewski (OXOS.pl)"
    author_email="wojciech@oxos.pl"
    author_location="Nowa SÃ³l, Poland">

    <!-- Declare feature dependencies. -->

    <!-- This one is not specific to Gmail contextual gadgets. -->
    <Require feature="dynamic-height"/>
    
    <Require feature="setprefs"/>

    <!-- The next feature, Caja, is optional, and is supported for
     use only within test domains. Uncomment the tag only for
     non-production gadgets. -->
    <!-- <Require feature="caja"/> -->

    <!-- The next feature, google.contentmatch, is required for all
     Gmail contextual gadgets.
     <Param> - specify one or more comma-separated extractor IDs in
     a param named "extractors". This line is overridden by the extractor ID
     in the manifest, but is still expected to be present. -->
    <Require feature="google.contentmatch">
      <Param name="extractors">
        google.com:SubjectExtractor
      </Param>
    </Require>

  </ModulePrefs>

  <!-- Define the content type and display location. The settings
   "html" and "card" are required for all Gmail contextual gadgets. -->
  <Content type="html" view="card">
      <![CDATA[	<span></span>

      <p>
	<button id="create_story_button">Create Story</button>
      </p>
      <div id='notification'>.</div>

      <div id='settings' style='font-size: small;'>
	<p>
	  <label for="pivotal_api_token_input">Pivotal API Token</label>
	  <input id="pivotal_api_token_input" name="pivotal_api_token" />
	</p>

	<p>
	  <label for="project_id_input">Project ID</label>
	  <input id="project_id_input" name="project_id" />
	</p>

	<p>
	  <label for="story_type_input">Story type</label>
	  <input id="story_type_input" name="story_type" />
	</p>

	<p>
	  <label for="requested_by_input">Requested by</label>
	  <input id="requested_by_input" name="requested_by" />
	</p>

	<p>
	  <label for="integration_id_input">Integration ID</label>
	  <input id="integration_id_input" name="integration_id" />
	</p>

	<p>
	  <label for="owner_input">Owner</label>
	  <input id="owner_input" name="owner" />
	</p>

	<input type='submit' id='save_settings' value="Save settings" />
      </div>

      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.4.4/jquery.min.js"></script>
      <script src="http://mustache.github.com/extras/mustache.js"></script>

      <script type="text/javascript">
	gadgets.window.adjustHeight(500);

	console.log( 'start' );

	var prefs = new gadgets.Prefs();

	var settings = [ 'pivotal_api_token', 'project_id', 'story_type', 'requested_by', 'integration_id', 'owner' ];
	for( i in settings ) {
	  $("#" + settings[i] + "_input").val( prefs.getString(settings[i]) );
	}

	$("#save_settings").click(function(){
	  for( i in settings ) {
	    var val = $("#" + settings[i] + "_input").val();
	    prefs.set(settings[i], val );
	  }
	  alert('settings saved');
	});

	var post_create_story = function( subject, message_id ) {
	  var stories_url = "http://www.pivotaltracker.com/services/v3/projects/145861/stories";
	  var params = {};
   	  params[gadgets.io.RequestParameters.METHOD] = gadgets.io.MethodType.POST;
   	  params[gadgets.io.RequestParameters.HEADERS] = {
	    "X-TrackerToken": prefs.getString('pivotal_api_token'),
	    "Content-type": "application/xml"
	  };
	  params[gadgets.io.RequestParameters.CONTENT_TYPE] = gadgets.io.ContentType.DOM;

	  var template = "<story>"
		       + "<project_id>{{project_id}}</project_id>"
		       + "<story_type>{{story_type}}</story_type>"
		       + "<name>{{name}}</name>"
		       + "<integration_id>{{integration_id}}</integration_id>"
		       + "<other_id>{{other_id}}</other_id>"
		       + "<requested_by>{{requested_by}}</requested_by>"
		       + "<owner>{{owner}}</owner>"
		       + "</story>";

	  var story_xml = Mustache.to_html(template, {
	    project_id: prefs.getString('project_id'),
	    story_type: prefs.getString('story_type'),
	    name: subject,
	    integration_id: prefs.getString('integration_id'),
	    other_id: message_id,
	    requested_by: prefs.getString('requested_by'),
	    owner: prefs.getString('owner')
	  } );
	  console.log( story_xml );
  
   	  params[gadgets.io.RequestParameters.POST_DATA] = story_xml;

	  var response_callback = function(response) {
	    console.log( response.text );

	    var respXML = null;
	    if (window.DOMParser) {
	      parser=new DOMParser();
	      respXML=parser.parseFromString(response.text,"text/xml");
	    } else {
	      respXML=new ActiveXObject("Microsoft.XMLDOM");
	      respXML.async="false";
	      respXML.loadXML(response.text); 
	    }

	    var url = $(respXML).find("url").text();
	    console.log( url );
	    //$("#notification").empty();
	    $("#notification").html( '<a href="' + url + '">' + url + '</a>' );
	    //$("<a />", {href: url}).text(url).appendTo( $("notification") );


	  };
	  gadgets.io.makeRequest(stories_url, response_callback, params);
	};

	var matches = google.contentmatch.getContentMatches();

	var inputs = {};
	for(var imatch in matches){
	  $.extend( inputs, matches[imatch] );
	}

	for(var key in inputs) {
	  console.log( "inputs[" + key + " ] => " + inputs[key] );
	}

	$('#create_story_button').click(function(){
	  post_create_story( inputs.subject, inputs.message_id );
	  gadgets.window.adjustHeight(300);
	});

      </script>
      ]]>
  </Content>
</Module>

